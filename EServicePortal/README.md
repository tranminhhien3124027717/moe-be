# MOE System - EService Portal

This is the EService Portal backend for the MOE System, built with .NET 10 and following Clean Architecture principles.

## Project Structure

```
EServicePortal/
├── src/
│   ├── MOE_System.EService.API/          # Presentation Layer (Controllers, Middleware, Filters)
│   ├── MOE_System.EService.Application/  # Application Layer (Services, DTOs, Validators, Interfaces)
│   ├── MOE_System.Domain/                # Domain Layer (Entities, Common Classes)
│   └── MOE_System.EService.Infrastructure/ # Infrastructure Layer (DbContext, Repositories, Services)
├── MOE_System.EService.UnitTest/         # Unit Tests
├── tests/                                # Integration Tests
├── MOE_System.EService.sln               # Solution File
└── Makefile                              # Build automation commands
```

## Architecture

This project follows Clean Architecture principles with the following layers:

- **Domain Layer**: Contains enterprise business rules and entities (scaffolded from database)
- **Application Layer**: Contains application business rules, interfaces, and DTOs
- **Infrastructure Layer**: Contains data access and external service implementations
- **API Layer**: Contains controllers, filters, middleware, and API configuration

**Note:** This project uses **Database First** approach. Entities and DbContext are generated from an existing database using EF Core scaffolding.

## Prerequisites

- .NET 10 SDK
- SQL Server (LocalDB or Express)
- Visual Studio 2022 or VS Code with C# extension

## Getting Started

### 1. Restore Dependencies

```bash
make restore
# or
dotnet restore
```

### 2. Update Database Connection String

Update the connection string in `src/MOE_System.EService.API/appsettings.json`:

```json
"ConnectionStrings": {
    "DefaultConnection": "Your_Connection_String_Here"
}
```

### 3. Scaffold Database (Database First)

Since this project uses Database First approach, you need to scaffold the DbContext and entities from an existing database:

**Option 1: Scaffold all tables**
```bash
make ef-scaffold conn="Server=.\SQLEXPRESS;Database=MOE_EService_DB;Trusted_Connection=True;Encrypt=False;"
```

**Option 2: Scaffold specific tables**
```bash
make ef-scaffold-tables conn="Server=.\SQLEXPRESS;Database=MOE_EService_DB;Trusted_Connection=True;Encrypt=False;" tables="Users,Orders,Products"
```

**Note:** 
- Replace the connection string with your actual database connection
- The scaffolding will generate entity classes in `src/MOE_System.EService.Infrastructure/Data/Entities/`
- The ApplicationDbContext will be regenerated in `src/MOE_System.EService.Infrastructure/Data/`

### 4. Run the Application

```bash
make run
# or
dotnet run --project src/MOE_System.EService.API
```

The API will be available at:
- HTTP: http://localhost:5222
- HTTPS: https://localhost:7215

Swagger documentation: http://localhost:5222/swagger

## Makefile Commands

| Command | Description |
|---------|-------------|
| `make restore` | Restore NuGet packages |
| `make build` | Build the solution |
| `make run` | Run the Web API project |
| `make test` | Run unit tests |
| `make clean` | Clean the solution |
| `make ef-scaffold conn="..."` | Scaffold DbContext and entities from database |
| `make ef-scaffold-tables conn="..." tables="..."` | Scaffold specific tables only |
| `make ef-list-tables` | List all tables in the database |
| `make help` | Show all available commands |

### Database First Commands

**Scaffold entire database:**
```bash
make ef-scaffold conn="Server=.\SQLEXPRESS;Database=MOE_EService_DB;Trusted_Connection=True;Encrypt=False;"
```

**Scaffold specific tables:**
```bash
make ef-scaffold-tables conn="Server=.\SQLEXPRESS;Database=MOE_EService_DB;Trusted_Connection=True;Encrypt=False;" tables="Table1,Table2,Table3"
```

## Development

### Working with Database First

**When database schema changes:**

1. **Re-scaffold the database:**
   ```bash
   make ef-scaffold conn="YourConnectionString"
   ```
   This will regenerate entity classes and DbContext

2. **Create DTOs** in `MOE_System.EService.Application/DTOs/` or `MOE_System.EService.Application/EService/DTOs/`

3. **Create interfaces** in `MOE_System.EService.Application/Interfaces/` or `MOE_System.EService.Application/EService/Interfaces/`

4. **Implement services** in `MOE_System.EService.Application/Services/` or `MOE_System.EService.Application/EService/Services/`

5. **Create custom repositories** (if needed) in `MOE_System.EService.Infrastructure/Repositories/`

6. **Create controllers** in `MOE_System.EService.API/Controllers/` or `MOE_System.EService.API/Controllers/EService/`

7. **Register services** in `DependencyInjection.cs` files

**Important Notes:**
- Entity classes are in `src/MOE_System.EService.Infrastructure/Data/Entities/` (generated by scaffolding)
- Don't manually edit generated entity classes - they will be overwritten
- Use partial classes if you need to extend generated entities
- ApplicationDbContext is regenerated each time you scaffold

### Testing

Run all tests:
```bash
make test
```

## Technologies Used

- .NET 10
- Entity Framework Core 10
- SQL Server
- FluentValidation
- Swagger/OpenAPI
- xUnit (for testing)
- Moq (for mocking)
- BCrypt.Net (for password hashing)

## License

[Your License Here]
